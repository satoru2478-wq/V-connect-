<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V_CONNECT // ULTRA</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00f3ff; --bg: #050510; --glass: rgba(15, 20, 35, 0.95); }
        body { margin: 0; background: var(--bg); color: var(--neon); font-family: 'Share Tech Mono'; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* UI */
        .panel { 
            background: var(--glass); border: 1px solid var(--neon); padding: 40px; 
            text-align: center; border-radius: 10px; width: 350px; 
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1); z-index: 100;
        }
        
        .btn-main {
            width: 100%; padding: 15px; margin: 10px 0; background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon);
            color: var(--neon); font-family: 'Orbitron'; font-size: 1rem; cursor: pointer; text-transform: uppercase;
        }
        .btn-main:hover { background: var(--neon); color: black; }

        input { width: 90%; padding: 15px; background: black; border: 1px solid #444; color: white; text-align: center; font-size: 1.5rem; letter-spacing: 5px; margin-bottom: 10px; }

        /* VIDEO AREA */
        #video-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; display: flex; justify-content: center; align-items: center; }
        
        /* Remote Video (Full Screen) */
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Local Video (Small Pip) */
        #local-video { 
            position: absolute; bottom: 20px; right: 20px; width: 120px; height: 180px; 
            border: 2px solid var(--neon); background: #111; object-fit: cover; z-index: 20;
        }

        .hidden { display: none !important; }
        
        /* DEBUG LOG (To see why it fails) */
        #debug-log {
            position: absolute; top: 10px; left: 10px; color: yellow; font-size: 0.7rem; 
            background: rgba(0,0,0,0.5); padding: 10px; pointer-events: none; z-index: 50;
        }
    </style>
</head>
<body>

    <div id="debug-log">SYSTEM READY...</div>

    <div id="menu-panel" class="panel">
        <h1 style="font-family:'Orbitron'; margin:0 0 20px 0;">V_CONNECT</h1>
        <button class="btn-main" onclick="initHost()">GENERATE KEY</button>
        <button class="btn-main" onclick="showJoin()">JOIN KEY</button>
    </div>

    <div id="host-panel" class="panel hidden">
        <h2>YOUR KEY</h2>
        <div id="generated-pin" style="font-size:3rem; font-family:'Orbitron'; margin:20px 0; border:2px dashed #333; padding:10px;">...</div>
        <div>WAITING FOR PEER...</div>
    </div>

    <div id="join-panel" class="panel hidden">
        <h2>ENTER KEY</h2>
        <input type="number" id="pin-input" placeholder="0000">
        <button class="btn-main" onclick="joinRoom()">CONNECT</button>
    </div>

    <div id="video-ui" class="hidden">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let localStream;
        let peerConnection;
        let currentRoom;
        
        // --- 1. ROBUST SERVER LIST (Fixes Network Issues) ---
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ]
        };

        function log(msg) {
            document.getElementById('debug-log').innerText += "\n" + msg;
            console.log(msg);
        }

        // --- 2. CAMERA START (Auto-Resolution) ---
        async function startCamera() {
            try {
                // We do NOT specify resolution to avoid crashing on low-end phones
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                log("Camera: OK");
            } catch(e) {
                log("Camera Error: " + e.message);
                alert("Please allow Camera Access!");
            }
        }

        // --- 3. UI LOGIC ---
        async function initHost() {
            await startCamera();
            document.getElementById('menu-panel').classList.add('hidden');
            document.getElementById('host-panel').classList.remove('hidden');
            socket.emit('create-room');
        }

        async function showJoin() {
            await startCamera();
            document.getElementById('menu-panel').classList.add('hidden');
            document.getElementById('join-panel').classList.remove('hidden');
        }

        function joinRoom() {
            const pin = document.getElementById('pin-input').value;
            currentRoom = pin;
            document.getElementById('join-panel').classList.add('hidden');
            document.getElementById('video-ui').classList.remove('hidden');
            log("Joining Room: " + pin);
            socket.emit('join-room', pin);
        }

        // --- 4. SOCKET & WEBRTC LOGIC ---

        socket.on('room-created', pin => {
            currentRoom = pin;
            document.getElementById('generated-pin').innerText = pin;
            log("Room Created: " + pin);
        });

        socket.on('user-connected', async () => {
            log("Peer detected. Initiating Call...");
            document.getElementById('host-panel').classList.add('hidden');
            document.getElementById('video-ui').classList.remove('hidden');
            
            createPeerConnection();
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('offer', { roomId: currentRoom, sdp: offer });
        });

        socket.on('offer', async (sdp) => {
            log("Offer Received. Sending Answer...");
            createPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(sdp));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', { roomId: currentRoom, sdp: answer });
        });

        socket.on('answer', (sdp) => {
            log("Answer Received. Connecting...");
            peerConnection.setRemoteDescription(new RTCSessionDescription(sdp));
        });

        socket.on('ice-candidate', (candidate) => {
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(e => log("ICE Error: " + e.message));
            }
        });

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);
            
            // Add Tracks
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Remote Stream Handler
            peerConnection.ontrack = event => {
                log("Stream received!");
                const video = document.getElementById('remote-video');
                video.srcObject = event.streams[0];
                video.onloadedmetadata = () => {
                    video.play();
                };
            };

            // ICE Handler
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { roomId: currentRoom, candidate: event.candidate });
                }
            };
            
            // Connection State Logging
            peerConnection.onconnectionstatechange = () => {
                log("State: " + peerConnection.connectionState);
                if(peerConnection.connectionState === "failed") {
                    alert("Connection Failed. Try switching one device to WiFi.");
                }
            };
        }
    </script>
</body>
</html>
